###### tags: `單元測試的藝術`

# Chapter 5 隔離(模擬)框架

### 5.4 測試事件相關活動

事件是雙向的，可以從兩個方向來進行測試

- 測試間聽的那一方
- 測試觸發事件的那一方

#### 5.4.1 測試監聽者

要解決第一個測試情境就是：檢查一個物件是否有註冊到另一個物件的一個事件。
比較好了設計方式：檢查監聽物件是否對發生的事件做出某種具體反應。如果監聽者沒有註冊到這個事件，那他就不會採取任何可觀察到的公開行為。

![](https://imgur.com/xqH2Dps.png)

###### 圖片來源：截圖原版電子書籍：單元測試的藝術 (英文版)

![](https://imgur.com/T7vX2uJ.png)

###### 圖片來源：截圖原版電子書籍：單元測試的藝術 (英文版)

需留意幾點：

- 這個模擬物件同時也是個需設常式物件
- 要觸發一個試驗，你需要在測試中註冊這個事件。這種做法是為了滿足編譯器的要求，因為事件相關的屬性編譯器會特別僅慎，編譯要求很嚴格，事件只能由宣告他們的類別或結構直接呼叫。

另一個情境則有兩個相依物件：一個 log 物件，另一個則是 View。
![](https://imgur.com/9BDOY9I.png)

###### 圖片來源：截圖原版電子書籍：單元測試的藝術 (英文版)

這邊使用了虛設常式物件

1. 觸發事件，一個模擬物件
2. 驗證是否正確的呼叫了 log 的服務

#### 5.4.2 測試事件是否觸發

測試事件的方式，就是在測試方法內部使用一個匿名委派，手動註冊這個方法
![](https://imgur.com/jJa5sET.png)

###### 圖片來源：截圖原版電子書籍：單元測試的藝術 (英文版)v

這個為委派只記錄了個事件是否被觸發，作者選擇使用委派而非 Laambda，因為他覺得用委派的可讀性比較好。

### 5.5 現有的.Net 隔離框架

NSub 不是唯一可用的隔離框架。
![](https://imgur.com/zHXwrXw.png)

###### 圖片來源：截圖原版電子書籍：單元測試的藝術 (英文版)

圖中是作者在 2012 年 8 月詢問他的讀者得來的結果。
雖然 Moq 是第一名，但作者卻不用 Moq，因為它所提供的錯誤訊息不夠明確，API 中 mock 這詞也出現的很多，使用 Moq 在建立虛設常式物件時，也得用 Mock 這個詞，容易混淆。

```csharp
為什麼不該在測試中使用方法名字字串(method strings)來指定要模擬的方打

如果你要修改產品程式碼中的一個方法名稱，在字串中使用了這個方法名字的測試，還是能成功編譯，但在執行時會失敗，拋出例外說找不到這個方法。

如果使用強型別的方法命名，修改方法名稱所造成的問題就不會存在了，因為測試中直接使用方法，方法的任何改變都會直接導致測試程式編譯失敗，並解立刻就能知報出現了一些問題。

如果是使用Uisual Studio就會有ReSharper for .NET自動重構工具
```

### 5.6 隔離框架的優缺點

- 更容易驗證參數
- 更容易驗證一個方法被多次呼叫
- 更容易建立假物件

========================================

#### 5.6.1 `使用隔離框架時應避免的陷阱`

在測試中過度使用模擬物件，會讓測試程式相當難以理解，或是沒有很好地拆分程式
要注意的列表如以下四點：

========================================

#### 5.6.2 `測試程式可讀性變差`

如果一個測試物件裡面有多個模擬物件，或很多意圖不同的驗證，就會降低可讀性，及難以維護。
如果已經變得不可讀或很難維護時，可以考慮去掉一些模擬物件或是期望模擬物件的互動，或是把測試拆分成幾個更小、更好理解的案例。

========================================

#### 5.6.3 `驗證了錯誤的東西`

模擬物件可以驗證測試是否正確地呼叫了見面的方法，卻不能保證你進行了正確的測試，最好的方式是測試當物件觸發了事件時，發生了一些有意義的事情。

========================================

#### 5.6.4 `一個測試中有多個模擬物件`

一個好的測試實踐原則，一個測試只測試一件事。同時測試多件事情容易造成混淆，會帶來測試維護上的問題。如果一個測試有多個模擬物件，就代表他會有多個最終結果。
如果發現事情太多，卻無法給出有意義的名字，那就是把它拆分開來。

========================================

#### 5.6.5 `過度指定的測試`

互動測試是一把雙面刃：測試過多，你會忽視全局，也就是整體功能。測試過少，你會錯過物件之間重要的互動

- 盡量使用非嚴格模擬物件

  - 如果產品成始碼中的私有方法總是在變化，使用非嚴格模擬物件會有幫助。

- 近兩使用虛設常試物件，而非模擬物件
  - 如果有 5%的測試使用了模擬物件，就是有濫用模擬物件的嫌疑。
  - 虛設常式物件到處都可以使用，模擬物件則不是這樣。
  - 一次只需要一個測試環境
  - 測試使用的模擬物件越多，結尾的驗證就越多，通常只需要一個驗證是重要的
  - 其餘的驗證都是對眼前的測試情境發出的噪音
- 極力避免把虛設常式物件當模擬物件使用
  - 只有在需要為被測試類別模擬回傳值或拋出例外時，才使用虛設嘗試物件，但不要驗證是否在測試中呼叫了一個虛設常式物件的用法，只有在驗證測試中會呼叫某個方法時，才使用模擬物件，但是不要用模擬物件來對被測試的類別回傳某個值

### 5.7 小結
