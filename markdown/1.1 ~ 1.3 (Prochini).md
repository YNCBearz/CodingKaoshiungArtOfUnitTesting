# 單元測試的藝術 第二版

英文版：　https://piazza.com/class_profile/get_resource/j11t8bsxngk3r3/j2lw6zcyt5t6lu
### 作者 Roy Osherove

![](https://i.imgur.com/wruiXYv.png)

- Osherove ONLINE TRAINING
COVID ALL-IN Free Learning Bundle
https://courses.osherove.com/p/covid-all-in-free-learning-bundle

### 譯者 陳仕傑 (91)

![](https://i.imgur.com/GX7saU2.png)

- 針對遺留代碼加入單元測試的藝術

## 序
### Robert C. Martin
無瑕的程式碼-番外篇
TDD 培訓課程
在開發者大會自彈自唱關於資料庫設計的歌
誰分得出 C# 跟 JAVA
![](https://i.imgur.com/EWa3WCr.png)

### Michael Feathers
非常年輕的工程領域
2009 年出第一版

### 陳仕傑 (91)
單元測試經驗 13 年

#### 一定要清楚的重點
- 了解如何隔離相依
- Stub 與 Mock 的差異，並熟練隔離框架
- 如何撰寫優秀的單元測試
- 如何在組織中導入單元測試
- 針對遺留程式碼的重構與測試，以及可測試性設計
#### 一定要避免的問題
- 測試結果不穩定
- 過度指定
- 一次不只測一件事
- 測試程式重複過多
- 可讀性差
#### 一定要會的必殺技-擷取與覆寫 (Extract and override)
- 可處理 90% 以上的遺留代碼不可測試問題，10% 是 static & sealed

## 前言
作者親身經驗一個最失敗的專案的單元測試
- 測試太脆弱，修改類別或方法都會導致測試失敗
- 沒人知道別人寫的測試是什麼意思
- 單元測試命名不夠清楚
- 測試之間相互依賴
- 維護和理解測試花費的時間 > 測試所能節省的時間

## 關於本書
### 學習路線圖
1. 單元測試的基礎知識: 測試框架、自動化測試特性
2. 破除依賴的進階技術: 模擬物件、虛設常式物件、隔離框架
3. 測試程式碼的組織方式、執行測試和重構測試結構的模式，撰寫測試的最佳實踐
4. 如何在一個組織內進行變革以及如何修改先有程式碼。
- 本書原始碼 https://github.com/royosherove/aout2


# Chapter 1 單元測試基礎
## 1.1 逐步定義單元測試
```
單元測試 定義 1.0 版
```
> 一個單元測試就是一段程式碼，這段程式碼去呼叫了另一段程式碼，驗證另一段程式碼假設的正確性。若該假設是錯的，單元測試會失敗，一個單元測試可以是一個方法或函數。

```
SUT 定義
```
> 代表 System Under Test，在測試中，被測試的東西稱為 SUT

```
單元 定義
```
> 作者認為代表系統中的「工作單元」，或是一個使用案例(use case)
```
工作單元　unit of　work 定義
```
> 從呼叫系統的一個公開方法，到產生一個測試「可見的最終結果」，在此期間內這個系統所發生的行為統稱為一個工作單元。
```
可見的最終結果 noticeable end result　定義
```
> - 被呼叫的公開方法回傳一個結果值 (非 void 函數)
> - 呼叫方法的前後，系統狀態或行為發生可見的變化，不需要透過查詢私有狀態就能取得。(ex: 系統可以登入之前尚未存在的使用者帳戶)
> - 呼叫一個不受測試的第三方系統，這個第三方系統沒有回傳值，或系統不使用回傳值(ex: 呼叫第三方 log 系統)

```
單元測試 定義 1.1 版
```
> 一個單元測試是一段程式呼叫一個工作單元，並驗證工作單元的一個具體最終結果。如果對這個最終結果的假設是錯誤的，那單元測試就失敗了。一個單元測試的範圍，可以小到一個方法，大到多個類別。

討論 : 單元測試的範圍 越小越好 ? 還是越大越好 ?


### 1.1.1 撰寫 "優秀" 單元測試的重要性

差勁的測試不如不要寫，以節省維護的成本跟節省時間
透過定義甚麼是優秀的單元測試，確保自己在撰寫單元測試時，有正確的目標。
要理解甚麼是優秀的單元測試，需要先了解開發人員在測試的時候在做甚麼。
How do you make sure that the code works today?

### 1.1.2 我們都寫過 (某種) 單元測試
- 透過 GUI 來觸發 SUT 的某個行為，驗證結果
![](https://i.imgur.com/CQvkRjY.png)
- 手刻的外部工具驗證
- 執行整個程式手動驗證
![](https://i.imgur.com/yZu59nP.png)

什麼是單元測試? 什麼不是單元測試?
## 1.2 優秀單元測試的特質

單元測試應該具備以下特質：

- 它應該是自動化，而且可被重複執行的
- 它應該容易被實現
- 它到第二天應該還有存在意義（不是臨時性的）
- 任何人都可以按個按鈕執行它
- 它的執行速度應該很快
- 它的執行結果應該一致，每一次的測試結果在沒有修改程式之前，都應該是一樣的。
- 它應該要能完全掌控被測試的單元
- 它應該是完全被隔離的（獨立於其他測試）測試之間必須要互相獨立，一個測試不應該依賴另一個測試。
- 如果它的執行結果是失敗的，應該要很簡單清楚地呈現我們的期望為何，問題在哪

## 1.3 整合測試
```
整合測試 定義
```
> 整合測試是對一個工作單元進行測試，而這個測試對被測試的單元並沒有完全的控制，而是使用該單元一個或多個真實依賴的相依物件，例如時間、網路、資料庫、執行緒或亂數產生器等等。

例如：一個測試無法控制系統時間，在程式中使用目前時間的 DateTimeNow，那麼每次測試執行所取得的都是不同時間，測試就容易不穩定。
整合測試還可能帶來一個問題：一次測試的東西太多。
![](https://i.imgur.com/RaB3WDK.png)

總體來說，整合測試會實際使用到真實的相依物件或資源，而單元測試則被測試單元與其他相依物件 隔離 開來，以保證單元測試的結果高度穩定。

![](https://i.imgur.com/RUcrn94.png)


### 1.3.1 自動化單元測試的優點 vs 非自動化整合測試的缺點

為什麼需要單元測試?
很多人把對軟體進行測試與單元測試的概念混為一談，你可以問自己以下幾個問題：
```
* 我兩週前所寫的單元測試，今天還能正常執行並得到結果嗎？兩個月前的呢？兩年前的呢？
```
不能? 那你怎麼確定自己是否已破壞原有程式的功能? 在產品開發過程中，程式會經常發生變化。如果在修改完程式之後，你不能對先前的所有功能做測試，就有極大可能發生改東壞西而不知情的狀況。
```
* 我兩個月前所寫的單元測試，團隊中任一人都能正常執行並得到結果嗎？
```
開發人員總是擔心程式碼修改遺留程式碼後程式是否還能正常運作，優秀的單元測試是可以被任何人存取與執行的，如果能透過單元測試確認自己不會破壞任何功能，就比較有信心接手不熟悉的程式碼。
```
* 我能在幾分鐘內跑完單元測試嗎？
```
單元測試執行速度必須要很快，你才會經常執行他們，盡早確認自己沒弄壞什麼功能，測試週期越長，對系統未經測試的修改越多，出現問題的原因點可能就越多。
```
* 我能一鍵執行所有我寫過的單元測試嗎？
```
若不能將單元測試完全自動化，還需要對機器去做手動設定或處理，大家就會懶得去測試，容易被忽略或跳過。

```
* 我能在幾分鐘內寫出一個基本的單元測試嗎？
```
整合測試需要話費較多時間，因為涉及內部和外部的依賴(ex 資料庫)，測試邏輯的覆蓋率比較低，很多核心程式碼不會被測試到。
撰寫測試難度越高，人願意撰寫的測試就越少。
單元測試關注每個問題的細節，而不是只關注大問題，測試的涵蓋率較高。也可以測試到程式碼中的核心邏輯。

* 如果以上任一題答案是「不能」，那可能你寫的不是單元測試，而是 某種有缺點的測試。

... 接下來讓我們看甚麼是優秀的單元測試