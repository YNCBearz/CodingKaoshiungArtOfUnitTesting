###### tags: `單元測試的藝術`
# Chapter 4 使用模擬物件驗證互動
### 4.1 基於值、狀態與互動的測試

互動測試針對結果類型：呼叫相依的第三方物件，基於回傳值的測試，驗證一個函數所傳回的值；基於狀態的測試，則透過取得的系統狀態，驗證被測試系統狀態的改變是否符合預期。
請記得盡量將互動測試作為最後一個選擇，你應該優先考慮能否使用前面兩個類型（基於回傳值或系統狀態）的測試，因為互動測試很多時候會讓事情變得複雜。

EX:灌溉系統驗證是否正確工作
1. **基於狀態的整合測試**:讓系統運作完完整的時間，最後判斷土壤、樹及葉子的狀態。
2. **互動測試**：在每個水管的末端，安裝一個設備，紀錄什麼時候有多少水流過去，驗證系統是否正常。

**互動測試**
> 是針對一個物件如何向其他物件發送訊息（呼叫方法）的測試，如果一個特定工作單元的最終結果，是呼叫另外一個物件，你就需要進行互動設。

**模擬物件**
> 是系統中的假物件，他可以拿來驗證被測試物件是否如預期般呼叫這個假物件，因此來使得單元測試執行成功或失敗。通常每個測試裡最多只會有一個模擬物件。

**假物件**
> 是通用的名詞，可以拿來描述一個虛設常式物件或是模擬物件，因為虛設常式物件或模擬物件看起來都很像真實的物件。如果這個假物件是拿來驗證物件之間的互動，那他就是模擬物件，反之，就是虛設常式物件。


### 4.2 模擬物件和虛設常式物件的差異

你用一個虛設常式物件來取代一個物件，以確保你能對待測試目標進行驗證。
![](https://i.imgur.com/bohv3lY.png)


要識別你是否使用了虛設常式物件，最簡單的方法是：虛設常式物件不會導致測試失敗，因為測試是針對測試類別進行驗證，而非虛設常式物件。
![](https://i.imgur.com/11lVu6m.png)


### 4.3 手刻模擬物件的簡單範例

建立和使用模擬物件的方式，跟虛設常式物件很像，只是用來模擬比虛設常式物件多做一件事情：他會蒐集所有互動的歷史，這些紀錄用來驗證是否符合預期。

**驗證功能不是直接寫在模擬物件裡面的**
1. 希望可以重複使用這個模擬物件。
2. 如果寫死在手刻的模擬物件裡面，那麼閱讀測試程式的人無法知道驗證動作是什麼，減低了測試的可讀性跟可維護性。

### 4.4 同時使用模擬物件和虛設常式

如果一個類別中不只要呼叫一個外部的程式，例如在一個Analyze類別中，同時會存取Web服務，此外他還會呼叫另外一個郵件發送有以下問題需要解決。


1. 如何替換掉Web服務
2. 如何模擬來自web服務引發的例外，以便測試有如預期般的呼叫郵件服務。
3. 如何判斷呼叫郵件服務的過程是否正確，或是真的有呼叫郵件服務的動作。

前二可以使用虛設常式來處理，第三個就使用一個模擬物件來取代郵件服務。

假設你的測試需要再失敗之後還是要驗證其他的值，這時候可以把所有要驗證的值包一起，以期待這次可以同時驗證結果。

### 4.5 每個測試只用一個模擬物件

如果一個測試只測一件事情，測試中應該最多就只有一個模擬物件，其他所有的假物件應該都是扮演虛設常數的角色。


**過度指定(overspecification)**
> 是指過度指定在測試中應該要發生的行為，而這些事情事實上對測試來說無關緊要。

### 4.6 假物件鏈：用虛設常式物件來產生模擬物件或其他虛設常式物件

很多軟體系統的設計可以建立複雜的物件鏈。

```
  IServiceFactory factory = GetServiceFactory(); 
  Iservice service = factory.GetService(); 
```

``` 
  String connection = GlobalUtil.Configuration.DBConfiguration;

```

物件鏈是個很強大的技術，但是很多時候你應該問自己，是否該重構為以下

```
String connstring = GetConnectionString();

protected virtual string GetConnectionString(){
  return GlobalUtil.Configuration.DBConfiguration;
}
```

### 4.7 手刻模擬物件和虛設常式物件的問題

1. 撰寫模擬物件和虛設常式需要很多時間
2. 如果類別和介面很多方法、屬性或事件，就很難為他手刻模擬物件或虛設常式物件。
3. 要保留模擬物件多次被呼叫的狀態，你需要在手刻的假物件中寫許多樣板程式。
4. 如果要驗證呼叫端針對一個方法所傳入的多個參數全是正確的，需要寫多個驗證語法，非常笨拙。
5. 難以在測試中重用模擬物件或虛設常式的程式碼。
   
  
一個模擬物件如果有帶有回傳值，他就能同時扮演著虛設常式物件。但是這是錯誤的方向，只會針對沒有回傳值的第三方物件互動來當作最終的結果。

### 4.8 小結

1. 一個模擬物件就類似虛設常式物件，但是他還能幫助你在測試中去驗證物件之間的互動。虛設常式物件並不會使測試執行失敗，只是拿來模擬各種情境。
2. 同一個測試中，同時使用模擬物件和虛設常式物件是一項強大的技術，但是你必須注意一個測試中不應該存在多個模擬物件。
3. 如果使用程式碼使用到其他物件取得資料，要注入假物件來取代相依物件，使用虛設常式物件來產生其他的模擬物件或虛設常式物件是一個強大的武器。這種對工廠類別和方法都極為適用。
4. 你需要合理的重組你的程式碼，讓讀測試程式的人可以輕易理解你的意圖和其中的邏輯。
5. 你會發現手刻的模擬物件和虛設常式物件，可能比框架產生更簡單跟容易理解。所以何時該使用工具是門藝術。